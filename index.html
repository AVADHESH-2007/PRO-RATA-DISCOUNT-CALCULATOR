<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Discount Calculator</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .container {
      width: 100vw;
      min-height: 100vh;
      margin: 0;
      padding: 24px 0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    table#invoiceTable {
      width: 100vw;
      max-width: 1800px;
      margin: 0 auto;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 2px solid #1976d2;
      table-layout: fixed;
      word-break: break-word;
      overflow-x: auto;
      display: block;
    }
    table#invoiceTable th, table#invoiceTable td {
      border: 1px solid #1976d2;
      padding: 6px 2px;
      text-align: center;
      font-size: 14px;
      overflow-wrap: break-word;
      word-break: break-word;
    }
    table#invoiceTable th {
      background: #1976d2;
      color: #fff;
      font-weight: bold;
    }
    table#invoiceTable th, table#invoiceTable td { min-width: 110px; }
    input[type="text"], input[type="number"], input[type="date"] {
      width: 100%;
      box-sizing: border-box;
      padding: 4px 6px;
      font-size: 13px;
      border: 1px solid #b0b8d1;
      border-radius: 4px;
      background: #f8faff;
    }
    input[type="date"]::-webkit-input-placeholder { color: #888; }
    input[type="date"]::-webkit-datetime-edit { color: #222; }
    @media (max-width: 1200px) {
      table#invoiceTable {
        width: 100vw;
        max-width: 100vw;
        display: block;
        overflow-x: auto;
      }
      table#invoiceTable th, table#invoiceTable td {
        font-size: 12px;
        padding: 4px 1px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PRO RATA DISCOUNT CALCULATOR</h1>
    <div class="controls">
      <button onclick="addRow()">Add Row</button>
      <button onclick="exportCSV()">Export CSV</button>
      <button onclick="downloadSampleCSV()">Sample CSV</button>
      <button onclick="selectAll()">Select All</button>
      <button onclick="deselectAll()">Deselect All</button>
      <button onclick="removeSelected()">Remove Selected</button>
      <button onclick="resetSelected()">Reset Selected</button>
      <input type="file" id="csvFileInput" onchange="importCSV(event)" accept=".csv" />
    </div>
    <table id="invoiceTable">
      <thead>
        <tr>
          <th>Select</th>
          <th>Sl. No.</th>
          <th>Product Code</th>
          <th>Description</th>
          <th>INVOICE NO.</th>
          <th>Invoice Date</th>
          <th>Due Date</th>
          <th>Quantity</th>
          <th>Unit Price</th>
          <th>Invoice Amount</th>
          <th>Payment Doc</th>
          <th>Payment Date</th>
          <th>Payment Amount</th>
          <th>Discount PMT</th>
          <th>Diff. Days</th>
          <th>Prop. Qty.</th>
          <th>Discount Amount</th>
          <th>Balance Amount</th>
          <th>Remarks</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- No sample row here; will be filled by JS if needed -->
      </tbody>
    </table>
  </div>
  <script>
    // Helper to get formatted date as DD-MM-YYYY
    function formatDate(date) {
      if (!date) return '';
      const d = new Date(date);
      if (isNaN(d)) return date;
      let day = '' + d.getDate();
      let month = '' + (d.getMonth() + 1);
      let year = d.getFullYear();
      if (day.length < 2) day = '0' + day;
      if (month.length < 2) month = '0' + month;
      return [day, month, year].join('-');
    }

    // --- Calculation Logic ---
    function calculateRow(tr) {
  const tds = tr.querySelectorAll('td');
  // Editable fields
  const qty = parseFloat(tds[7]?.querySelector('input')?.value);
  const invAmt = parseFloat(tds[9]?.querySelector('input')?.value);
  const payAmt = parseFloat(tds[12]?.querySelector('input')?.value);
  const discPmt = parseFloat(tds[13]?.querySelector('input')?.value);

  // Dates
  const dueDateStr = tds[6]?.querySelector('input')?.value;
  const payDateStr = tds[11]?.querySelector('input')?.value;

  // --- Diff. Days ---
  let diffDays = '';
  if (dueDateStr && payDateStr) {
    const [d1, m1, y1] = dueDateStr.split('-').map(Number);
    const [d2, m2, y2] = payDateStr.split('-').map(Number);
    const dueDate = new Date(y1, m1 - 1, d1);
    const payDate = new Date(y2, m2 - 1, d2);
    if (!isNaN(dueDate) && !isNaN(payDate)) {
      if (payDate > dueDate) {
        diffDays = "N.A.";
      } else {
        diffDays = Math.round((dueDate - payDate) / (1000 * 60 * 60 * 24));
      }
    }
  }
  if (tds[14]) tds[14].textContent = diffDays !== '' ? diffDays : '';

  // --- Unit Price ---
  let unitPrice = (typeof qty === "number" && qty > 0 && typeof invAmt === "number" && !isNaN(invAmt)) ? (invAmt / qty) : '';
  if (tds[8]?.querySelector('input')) {
    tds[8].querySelector('input').value = unitPrice !== '' && !isNaN(unitPrice) ? unitPrice.toFixed(2) : '';
  }

  // --- Prop. Qty. ---
  let propQty = (typeof unitPrice === "number" && unitPrice > 0 && typeof payAmt === "number" && !isNaN(payAmt)) ? (payAmt / unitPrice) : '';
  if (tds[15]) tds[15].textContent = propQty !== '' && !isNaN(propQty) ? propQty.toFixed(2) : '';

  // --- Discount Amount ---
  let discAmt = '';
  if (
    typeof discPmt === "number" && !isNaN(discPmt) &&
    diffDays !== '' && diffDays !== "N.A." &&
    typeof diffDays === "number" && !isNaN(diffDays) &&
    typeof propQty === "number" && !isNaN(propQty)
  ) {
    discAmt = discPmt * diffDays * propQty;
    if (tds[16]) tds[16].textContent = discAmt.toFixed(2);
  } else {
    if (tds[16]) tds[16].textContent = "N.A.";
    discAmt = "N.A.";
  }

  // --- Balance Amt ---
  let balAmt = '';
  if (
    typeof invAmt === "number" && !isNaN(invAmt) &&
    typeof payAmt === "number" && !isNaN(payAmt) &&
    typeof discAmt === "number" && !isNaN(discAmt)
  ) {
    balAmt = (invAmt - payAmt - discAmt).toFixed(2);
  } else {
    balAmt = "N.A.";
  }
  if (tds[17]?.querySelector('input')) {
    tds[17].querySelector('input').value = balAmt;
  }
}

    // Calculate all rows
    function calculateDiscounts() {
      document.querySelectorAll('#tableBody tr').forEach(tr => calculateRow(tr));
    }

    // --- Event Binding ---
    function bindRowEvents(tr) {
      // Listen to changes on all editable inputs in the row
      tr.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
        if (!input.readOnly) {
          input.addEventListener('input', () => {
            calculateRow(tr);
          });
        }
      });
    }

    // Bind events for all rows (existing and future)
    function bindAllRows() {
      document.querySelectorAll('#tableBody tr').forEach(tr => bindRowEvents(tr));
    }

    // Add Row
    function addRow() {
      const tbody = document.getElementById('tableBody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox"/></td>
        <td></td>
        <td><input type="text" /></td>
        <td><input type="text" /></td>
        <td><input type="text" /></td>
        <td><input type="text" class="date-input" maxlength="10" placeholder="DD-MM-YYYY" /></td>
        <td><input type="text" class="date-input" maxlength="10" placeholder="DD-MM-YYYY" /></td>
        <td><input type="number" min="0" /></td>
        <td><input type="number" min="0" readonly /></td>
        <td><input type="number" min="0" /></td>
        <td><input type="text" /></td>
        <td><input type="text" class="date-input" maxlength="10" placeholder="DD-MM-YYYY" /></td>
        <td><input type="number" min="0" /></td>
        <td><input type="number" min="0" /></td>
        <td></td>
        <td></td>
        <td></td>
        <td><input type="number" readonly /></td>
        <td><input type="text" /></td>
      `;
      tbody.appendChild(tr);
      updateSlNo();
      bindRowEvents(tr);
    }

    // Update Sl.No. for all rows
    function updateSlNo() {
      const rows = document.querySelectorAll('#tableBody tr');
      rows.forEach((tr, idx) => {
        const slNoCell = tr.querySelectorAll('td')[1];
        if (slNoCell) slNoCell.textContent = idx + 1;
      });
    }

    // Export CSV
    function exportCSV() {
      updateSlNo();
      const rows = [];
      document.querySelectorAll('#invoiceTable tr').forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('th,td')).map(td => {
          if (td.querySelector('input')) return td.querySelector('input').value || '';
          return td.innerText;
        });
        rows.push(cells.join(','));
      });
      const csvContent = rows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'discounts.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Download Sample CSV
    function downloadSampleCSV() {
      const header = [
        "Product Code",      // 0
        "Description",       // 1
        "Invoice #",         // 2
        "Invoice Date",      // 3
        "Due Date",          // 4
        "Quantity",          // 5
        "Unit Price",        // 6
        "Invoice Amount",    // 7
        "Payment Doc",       // 8
        "Payment Date",      // 9
        "Payment Amount",    //10
        "Discount PMT",      //11
        "Diff. Days",        //12
        "Prop. Qty.",        //13
        "Discount Amt",      //14
        "Balance Amt.",      //15
        "Remarks"            //16
      ];
      // Fill calculated columns with empty values, only editable columns with data
      const sample = [
        "PRD001",            // Product Code
        "Sample Product",    // Description
        "INV123",            // Invoice #
        "01-06-2024",        // Invoice Date
        "30-06-2024",        // Due Date
        "10",                // Quantity
        "",                  // Unit Price (calculated)
        "1000",              // Invoice Amount
        "PAY456",            // Payment Doc
        "15-06-2024",        // Payment Date
        "500",               // Payment Amount
        "5",                 // Discount PMT
        "",                  // Diff. Days (calculated)
        "",                  // Prop. Qty. (calculated)
        "",                  // Discount Amt (calculated)
        "",                  // Balance Amt. (calculated)
        ""                   // Remarks (editable)
      ];
      const csvContent = header.join(',') + '\n' + sample.join(',');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sample_discount.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- Local Storage Helpers ---
    function saveTableToStorage() {
      const rows = [];
      document.querySelectorAll('#tableBody tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        rows.push([
          tds[2]?.querySelector('input')?.value || '', // Product Code
          tds[3]?.querySelector('input')?.value || '', // Description
          tds[4]?.querySelector('input')?.value || '', // Invoice No
          tds[5]?.querySelector('input')?.value || '', // Invoice Date
          tds[6]?.querySelector('input')?.value || '', // Due Date
          tds[7]?.querySelector('input')?.value || '', // Quantity
          tds[8]?.querySelector('input')?.value || '', // Unit Price
          tds[9]?.querySelector('input')?.value || '', // Invoice Amount
          tds[10]?.querySelector('input')?.value || '', // Payment Doc
          tds[11]?.querySelector('input')?.value || '', // Payment Date
          tds[12]?.querySelector('input')?.value || '', // Payment Amount
          tds[13]?.querySelector('input')?.value || '', // Discount PMT
          tds[18]?.querySelector('input')?.value || ''  // Remarks
        ]);
      });
      localStorage.setItem('dc_table_data', JSON.stringify(rows));
    }

    function loadTableFromStorage() {
      const data = localStorage.getItem('dc_table_data');
      if (!data) return false;
      const rows = JSON.parse(data);
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      rows.forEach(cols => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox"/></td>
          <td></td>
          <td><input type="text" value="${cols[0] || ''}" /></td>
          <td><input type="text" value="${cols[1] || ''}" /></td>
          <td><input type="text" value="${cols[2] || ''}" /></td>
          <td><input type="text" value="${cols[3] || ''}" class="date-input" maxlength="10" placeholder="DD-MM-YYYY" /></td>
          <td><input type="text" value="${cols[4] || ''}" class="date-input" maxlength="10" placeholder="DD-MM-YYYY" /></td>
          <td><input type="number" value="${cols[5] || ''}" min="0" /></td>
          <td><input type="number" value="${cols[6] || ''}" min="0" readonly /></td>
          <td><input type="number" value="${cols[7] || ''}" min="0" /></td>
          <td><input type="text" value="${cols[8] || ''}" /></td>
          <td><input type="text" value="${cols[9] || ''}" class="date-input" maxlength="10" placeholder="DD-MM-YYYY" /></td>
          <td><input type="number" value="${cols[10] || ''}" min="0" /></td>
          <td><input type="number" value="${cols[11] || ''}" min="0" /></td>
          <td></td>
          <td></td>
          <td></td>
          <td><input type="number" readonly /></td>
          <td><input type="text" value="${cols[12] || ''}" /></td>
        `;
        tbody.appendChild(tr);
        bindRowEvents(tr);
      });
      updateSlNo();
      calculateDiscounts();
      return true;
    }

    // Save table on every input change
    function bindRowEvents(tr) {
      tr.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
        if (!input.readOnly) {
          input.addEventListener('input', () => {
            calculateRow(tr);
            saveTableToStorage();
          });
        }
      });
      // Also save when checkbox is toggled (for select/deselect)
      tr.querySelector('input[type="checkbox"]').addEventListener('change', saveTableToStorage);
    }

    // Save table after row add/remove/reset/import
    function addRow() {
      const tbody = document.getElementById('tableBody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox"/></td>
        <td></td>
        <td><input type="text" /></td>
        <td><input type="text" /></td>
        <td><input type="text" /></td>
        <td><input type="text" class="date-input" maxlength="10" placeholder="DD-MM-YYYY" /></td>
        <td><input type="text" class="date-input" maxlength="10" placeholder="DD-MM-YYYY" /></td>
        <td><input type="number" min="0" /></td>
        <td><input type="number" min="0" readonly /></td>
        <td><input type="number" min="0" /></td>
        <td><input type="text" /></td>
        <td><input type="text" class="date-input" maxlength="10" placeholder="DD-MM-YYYY" /></td>
        <td><input type="number" min="0" /></td>
        <td><input type="number" min="0" /></td>
        <td></td>
        <td></td>
        <td></td>
        <td><input type="number" readonly /></td>
        <td><input type="text" /></td>
      `;
      tbody.appendChild(tr);
      updateSlNo();
      bindRowEvents(tr);
      saveTableToStorage();
    }
    function removeSelected() {
      document.querySelectorAll('#invoiceTable tbody input[type="checkbox"]:checked').forEach(cb => cb.closest('tr').remove());
      updateSlNo();
      saveTableToStorage();
    }
    function resetSelected() {
      document.querySelectorAll('#invoiceTable tbody input[type="checkbox"]:checked').forEach(cb => {
        let tds = cb.closest('tr').querySelectorAll('td');
        // Reset only editable fields
        if (tds[2].querySelector('input')) tds[2].querySelector('input').value = '';
        if (tds[3].querySelector('input')) tds[3].querySelector('input').value = '';
        if (tds[4].querySelector('input')) tds[4].querySelector('input').value = '';
        if (tds[5].querySelector('input')) tds[5].querySelector('input').value = '';
        if (tds[6].querySelector('input')) tds[6].querySelector('input').value = '';
        if (tds[7].querySelector('input')) tds[7].querySelector('input').value = '';
        if (tds[8].querySelector('input')) tds[8].querySelector('input').value = '';
        if (tds[9].querySelector('input')) tds[9].querySelector('input').value = '';
        if (tds[10].querySelector('input')) tds[10].querySelector('input').value = '';
        if (tds[11].querySelector('input')) tds[11].querySelector('input').value = '';
        if (tds[12].querySelector('input')) tds[12].querySelector('input').value = '';
        if (tds[13].querySelector('input')) tds[13].querySelector('input').value = '';
      });
      calculateDiscounts();
      saveTableToStorage();
    }
    function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.trim().split('\n');
        if (lines.length < 2) return;
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(',');
          // Fill only editable columns, rest blank
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" /></td>
            <td></td>
            <td><input type="text" value="${cols[0] || ''}" /></td>
            <td><input type="text" value="${cols[1] || ''}" /></td>
            <td><input type="text" value="${cols[2] || ''}" /></td>
            <td><input type="text" value="${cols[3] || ''}" class="date-input" maxlength="10" placeholder="DD-MM-YYYY" /></td>
            <td><input type="text" value="${cols[4] || ''}" class="date-input" maxlength="10" placeholder="DD-MM-YYYY" /></td>
            <td><input type="number" value="${cols[5] || ''}" min="0" /></td>
            <td><input type="number" value="" min="0" readonly /></td>
            <td><input type="number" value="${cols[7] || ''}" min="0" /></td>
            <td><input type="text" value="${cols[8] || ''}" /></td>
            <td><input type="text" value="${cols[9] || ''}" class="date-input" maxlength="10" placeholder="DD-MM-YYYY" /></td>
            <td><input type="number" value="${cols[10] || ''}" min="0" /></td>
            <td><input type="number" value="${cols[11] || ''}" min="0" /></td>
            <td></td>
            <td></td>
            <td></td>
            <td><input type="number" readonly /></td>
            <td><input type="text" value="${cols[16] || ''}" /></td>
          `;
          tbody.appendChild(tr);
          bindRowEvents(tr);
        }
        updateSlNo();
        calculateDiscounts();
        saveTableToStorage();
      };
      reader.readAsText(file);
    }

    // Optional: force date input to DD-MM-YYYY format
    document.addEventListener('input', function(e) {
      if (e.target.classList.contains('date-input')) {
        let v = e.target.value.replace(/[^0-9]/g, '');
        if (v.length > 2) v = v.slice(0,2) + '-' + v.slice(2);
        if (v.length > 5) v = v.slice(0,5) + '-' + v.slice(5,9);
        e.target.value = v.slice(0,10);
      }
    });

    // --- Initial Bindings ---
    window.addEventListener('DOMContentLoaded', () => {
      // Load from storage or start with one blank row
      if (!loadTableFromStorage()) {
        // No data in storage, add exactly one blank row
        addRow();
      }
      // Bind all rows (if any)
      bindAllRows();
      // Calculate all rows initially
      calculateDiscounts();
    });
  </script>
</body>
</html>
